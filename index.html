<button id="start-btn">Start Audio</button>

<script>
  const startBtn = document.getElementById('start-btn');
  startBtn.addEventListener('click', async () => {
    await Tone.start();
    console.log('Audio context started');
    startBtn.style.display = 'none';  // hide button after start
  });
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Web Music Player & Recorder - G Major Scale</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 10px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    #keyboard {
      display: flex;
      justify-content: center;
      margin: 20px 0;
      gap: 8px;
    }
    .key {
      width: 40px;
      height: 120px;
      background: white;
      border: 2px solid #444;
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      user-select: none;
      transition: background-color 0.2s;
    }
    .key:active, .key.playing {
      background-color: #a5d6ff;
      border-color: #2196f3;
      box-shadow: 0 0 15px #2196f3;
    }
    .label-key {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .label-note {
      font-size: 14px;
      color: #555;
      margin-bottom: 8px;
    }
    #recordings {
      margin-top: 40px;
    }
    .recording-slot {
      background: white;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .recording-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    button {
      cursor: pointer;
      border: none;
      padding: 6px 12px;
      background: #2196f3;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    button:hover {
      background: #1976d2;
    }
    a.download-link {
      color: #2196f3;
      text-decoration: none;
      font-weight: bold;
      margin-left: auto;
    }
    a.download-link:hover {
      text-decoration: underline;
    }
    #instructions {
      max-width: 700px;
      margin: 0 auto 20px;
      font-size: 14px;
      line-height: 1.5;
      color: #444;
    }
  </style>
</head>
<body>

<h1>üé∂ Web Music Recorder & Player - G Major Scale</h1>

<div id="instructions">
  <p><strong>Play notes:</strong> Use your keyboard keys <code>A</code> to <code>L</code> to play G major scale notes.</p>
  <p><strong>Record/play:</strong> Press number keys <code>1</code> to <code>9</code> and <code>0</code> (for slot 10) to start/stop recording.</p>
  <p>Use the buttons below to play or download your recordings.</p>
</div>

<div id="keyboard"></div>

<div id="recordings"></div>

<script src="https://unpkg.com/tone/build/Tone.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mattdiamond/Recorderjs@master/dist/recorder.js"></script>
<script src="https://unpkg.com/wavesurfer.js"></script>

<script>

  // Tone.js synth + effects setup
  const synth = new Tone.Synth().toDestination();
  const delay = new Tone.FeedbackDelay("8n", 0.4).toDestination();
  const reverb = new Tone.Reverb({ decay: 4, wet: 0.3 }).toDestination();
  synth.connect(delay);
  synth.connect(reverb);

  const audioContext = Tone.context;
  const destination = audioContext.createMediaStreamDestination();
  const recorder = new Recorder(destination);
  synth.connect(destination);
  delay.connect(destination);
  reverb.connect(destination);

  // Map keys A-L to G major scale notes
  const keyNoteMap = {
    'a': 'G4',
    's': 'A4',
    'd': 'B4',
    'f': 'C5',
    'g': 'D5',
    'h': 'E5',
    'j': 'F#5',
    'k': 'G5',
    'l': 'A5'
  };

  // Show keyboard keys visually
  const keyboardDiv = document.getElementById('keyboard');
  for (const [key, note] of Object.entries(keyNoteMap)) {
    const keyDiv = document.createElement('div');
    keyDiv.className = 'key';
    keyDiv.id = `key-${key}`;
    keyDiv.innerHTML = `<div class="label-key">${key.toUpperCase()}</div><div class="label-note">${note}</div>`;
    keyboardDiv.appendChild(keyDiv);

    // Also allow clicking on onscreen keys to play notes
    keyDiv.addEventListener('mousedown', async () => {
      await Tone.start();
      synth.triggerAttackRelease(note, "8n");
      keyDiv.classList.add('playing');
      setTimeout(() => keyDiv.classList.remove('playing'), 150);
    });
  }

  // Recording slots and wavesurfers
  const recordings = {};
  const wavesurfers = {};

  function createWaveform(blob, slot) {
    const url = URL.createObjectURL(blob);
    let container = document.getElementById(`recording-container-${slot}`);

    if (!container) {
      container = document.createElement('div');
      container.id = `recording-container-${slot}`;
      container.className = 'recording-slot';
      document.getElementById('recordings').appendChild(container);
    }

    container.innerHTML = `
      <div class="recording-header">
        <strong>Recording Slot ${slot}</strong>
        <button id="play-btn-${slot}">‚ñ∂Ô∏è Play</button>
        <a class="download-link" href="${url}" download="recording-${slot}.wav">üíæ Download</a>
      </div>
      <div id="wave-${slot}"></div>
    `;

    if (wavesurfers[slot]) {
      wavesurfers[slot].destroy();
    }

    wavesurfers[slot] = WaveSurfer.create({
      container: `#wave-${slot}`,
      waveColor: 'violet',
      progressColor: 'purple',
      height: 80,
      interact: true,
      normalize: true
    });
    wavesurfers[slot].load(url);

    // Play button toggles play/pause
    document.getElementById(`play-btn-${slot}`).onclick = () => {
      wavesurfers[slot].playPause();
    };
  }

  // Map '0' key to slot 10
  function keyToSlot(key) {
    if (key === '0') return '10';
    if ('123456789'.includes(key)) return key;
    return null;
  }

  document.addEventListener('keydown', async (e) => {
    // Play notes on A-L keys
    if (keyNoteMap[e.key]) {
      await Tone.start();
      synth.triggerAttackRelease(keyNoteMap[e.key], "8n");
      const keyDiv = document.getElementById(`key-${e.key}`);
      if (keyDiv) {
        keyDiv.classList.add('playing');
        setTimeout(() => keyDiv.classList.remove('playing'), 150);
      }
    }

    // Handle recording slots (1-9,0)
    const slot = keyToSlot(e.key);
    if (slot) {
      if (recorder.recording) {
        recorder.stop();
        recorder.exportWAV(blob => {
          recordings[slot] = blob;
          createWaveform(blob, slot);
          console.log(`Stopped recording slot ${slot}`);
        });
      } else {
        recorder.clear();
        recorder.record();
        console.log(`Started recording slot ${slot}`);
      }
    }
  });
</script>

</body>
</html>
